Differences in security between the last and the current governments in Mexico 
========================================================

Last Presidential term (2006-2012) in Mexico was characterized for the violence generated by the war against drug cartels. The current president belongs to a different party and he claimed that his security strategy would be more effective.

In this work, I will try to analize different security indicators for different Presidential terms: 2000-2006, 2006-2012 and 2012-present to see if there are clear differences in security betweeen goverments. 

The webpage [http://crimenmexico.diegovalle.net/en/](http://crimenmexico.diegovalle.net/en/) by [Diego Valle Jones](http://www.diegovalle.net), has some illustrative plots of a subset of crimes-related variables from the site [Secretariado Ejecutivo del Sistema Nacional de Seguridad Pública](http://www.secretariadoejecutivo.gob.mx/es/SecretariadoEjecutivo/Incidencia_Delictiva). To be clear, what I plan to do is to use the same source to read all the variables and then generate plots to compare the different Presidential terms.

The data has some irregularities, such as events not recorded for some periods of time, but I will try to do the best I can. It might be a good idea to use `shiny` to create a more complete work.

The webpage where the data is available has menus to select to customize your search and then download the data in several formats. Well, those menus never work. However, I have found another link within the same webpage to download the data in pdf. Right now, I am exploring the possibility of downloading the data directly from the pdf files using `R`, perhaps using the package `tm`.

Description of the data
----------------------------------------------

According to the Federal Attorney General of Mexico, the data is categorized in two types:
- Federal: Those crimes that affect the health, the economy or the security of the country. Examples of this crimes are illegal drug trade, ecological damage  and illegal carraige of weapons.
  - Against public health: trading, posession, production suplying, traffic, transportation and others.
  - Federal Law of Firearms and Explosives
  - Others: Intelectual property, against natural environment, election related, etcetera.
- Common: Those crimes that affect people directly. Examples of this crimes are sexual assaults, homicides and robbery. 
  - Offenses against property.
  - Sexual crimes
  - Homicides.
  - Injuries.
  - Kidnapping.
  - Common robbery.
  - Cattle raiding.
  - Road robbery.
  - Robbery in banks
  - Others.

Data extraction and associated complications
-------------------------------------------------

The data extraction turned out to be more difficult than I thought. The website of [Secretariado Ejecutivo del Sistema Nacional de Seguridad Pública](http://www.secretariadoejecutivo.gob.mx/es/SecretariadoEjecutivo/Incidencia_Delictiva) displays the following menu (it is in Spanish, but most of the words are cognates):

![02](./webpages_images/02_menu.png)

If the first option is selected, _Herramientas de Análisis_  (Analysis tools), you can create plots for the features and also download the data you are plotting, however, it never works well. The next image is a screenshot the site.

![04](./webpages_images/04_analysis.png)

If you select the option _Exportación de Información_ (Exporting information), you can download the features that you want directly in a `csv` file. My idea was to try to do this automatically from `R`, but it never worked for me, not even manually. The following image shows that menu:
![03](./webpages_images/03_csv.png)

Finally, you can also download the tables in `pdf` files. I found a package in R that could help to obtain the information from tables in `pdf`, however, not all the information is available in `pdf`.

I sent an email message to Diego Valle. He told me that he decided to create those plots precisely because the [goverment webpage](http://www.secretariadoejecutivo.gob.mx/es/SecretariadoEjecutivo/Incidencia_Delictiva) never works. He send me his code in `Python` and he highlighted that he is constantly checking for new information and he extracts very little pieces of information since the wepages crashes otherwise. 

I decided then to use the data directly from [Diego Valle's website](http://crimenmexico.diegovalle.net/en/csv/). If I have time, I will work downloading the data by myself once I finish the other thing I want to do.

The work so far
---------------------------------------------------

Loading packages that will be used.
```{r}
suppressPackageStartupMessages(library("ggplot2"))
suppressPackageStartupMessages(library("plyr"))
suppressPackageStartupMessages(library("dplyr"))
suppressPackageStartupMessages(library("lubridate"))
```

Then we read the data and create a date-type variable.

```{r reading, cache = TRUE}
# ### Download directly. It takes a lot of time
# ### Do not run!
# federal.link <- "http://crimenmexico.diegovalle.net/en/csv/fuero-federal-estados.csv.gz"
# common.link <- "http://crimenmexico.diegovalle.net/en/csv/fuero-comun-estados.csv.gz"
# con <- gzcon(url(federal.link))
# txt <- readLines(con)
# dat <- read.csv(textConnection(txt))

### Reading data.
dat <- read.csv(gzfile("./data/fuero-comun-estados.csv.gz")) %.% tbl_df()

# str(dat)
# names(dat)

dat <- filter(dat, crime != "OTROS DELITOS") %.% # Filter "other crimes"
  mutate(date = ymd(paste(year, month, "01", sep = "-"))) %.% # Adding date
  group_by(year, month, crime, date)
```

Each presidential term lasts six years. We have to associate with each date the days that the corresponding president has ruled the country and the political party. 

On the other hand, we also have to correct the state codes, since there are states with the worng labels. Since the Spanish diccionary does not longer consider the _ch_ combination as a letter, so the alphabetical order of the states is slightly different.

```{r, dependson= "reading", cache = TRUE}
### This is the first day of goverment period for recorded data, i.e.,
## We have data starting on 1997. That president started his period on 1994-12-01
day0 <- ymd("1994-12-01")

## Now we add days of goverment and period of goverment.
aux <- function(date)
{
  ## Aux function to determine the period.
  ## Receives date type argument
  val <- ifelse(date < day0 + years(6), 0,
                ifelse(date < day0 + years(2*6), 1,
                       ifelse(date < day0 + years(3*6), 2, 
                              3)
                )
  ) 
  return(val)
}

dat <- mutate(dat, period.code = aux(date),
              days = as.numeric(date - years(period.code*6) - day0),
              party = c("PAN", "PRI")[((period.code == 0) | (period.code == 3)) + 1]) %.%
  group_by(period.code, days, party)
rm(aux)

## We also have to add the right state code, it is wrong beacuse the 'ch'
## is no longer considered "letter" in the Spanish diccitionary
aux <- function(code) 
{
  code[(code == 5) | (code == 6)] <- -1*(code[(code == 5) | (code == 6)] + 2)
  code[(code == 7) | (code == 8)] <- code[(code == 7) | (code == 8)] - 2
  code[code < 0] <- -code[code < 0]
  
  return(code)
}
dat <- mutate(dat, state_code = aux(state_code))
rm(aux)

```

Finally, 

```{r code, cache = TRUE}

## Creating table by states and adding 
state.wise <- summarise(group_by(dat, state_code, population), 
                        total = sum(count, na.rm = T)) %.%
  mutate(total.rate = 10000*total/population)  

## Same for the whole country
pop <- (dat %.% summarise(pop =  sum(unique(population))))$pop #  Population
national <- summarise(dat, total = sum(count, na.rm = T))
national$total.rate <- 10000*national$total/pop

### Homicides
qplot(days, total.rate, 
      data = filter(national, crime == "HOMICIDIOS"), 
      geom = "line", col = as.factor(period.code)) +
  ggtitle("Homicides rate by days of goverment")

### Homicides
qplot(date, total.rate, 
      data = filter(national, crime == "HOMICIDIOS"), 
      geom = "line", col = as.factor(period.code)) +
  ggtitle("Homicides rate by date")



# ##### Extracting polygons and saving data.frame, so it will not be run again.
# library("maptools")
# xx <- readShapeSpatial("../mexico/MEX_adm1.shp")
# xxx <- thinnedSpatialPoly(as(xx, "SpatialPolygons"), tolerance = 0.1, minarea = 0.0005, 
#                           topologyPreserve = TRUE)
# extractPolygons <- function(shapes) {
#   require(plyr)
#   
#   dframe <- ldply(1:length(shapes@polygons), function(i) {
#     ob <- shapes@polygons[[i]]@Polygons
#     dframe <- ldply(1:length(ob), function(j) {
#       x <- ob[[j]]
#       co <- x@coords
#       data.frame(co, order = 1:nrow(co), group = j)
#     })
#     dframe$region <- i
#     dframe
#   })
#   # construct a group variable from both group and polygon:
#   dframe$group <- interaction(dframe$region, dframe$group)
#   
#   dframe
# }
# mex <- extractPolygons(xxx)
# write.csv(mex, "../mexico/polygons.csv")

mex <- read.csv("./mexico/polygons.csv")[, -1]

head(mex)
unique(mex$re)

## Associating value with response
value <- (filter(state.wise, month == 1, 
       year == 2009, crime == "HOMICIDIOS") %.% 
         arrange(state_code))$total.rate

homicides.2009.1 <- mutate(mex, value = value[region])

value <- (filter(state.wise, month == 1, 
                 year == 2014, crime == "HOMICIDIOS") %.% 
            arrange(state_code))$total.rate
homicides.2014.1 <- mutate(mex, value = value[region])

homicides <- rbind(cbind(homicides.2014.1, date = "Jan 2014"),
                   cbind(homicides.2009.1, date = "Jan 2009")) 

qplot(x, y, order = order, group = group, data = homicides, 
       geom = "polygon", fill = value, facets = ~ date) + 
  scale_fill_gradient(low='white', high='darkred') 

###################################################
### Part of the trials for downloading the data
###################################################
# 
# library(XML) ## Loading library to read websites.
# 
# ## Main Page
# url <- "http://www.secretariadoejecutivo.gob.mx/es/SecretariadoEjecutivo/Incidencia_Delictiva"
# ## Crimes page
# url <- "http://www.incidenciadelictiva.secretariadoejecutivo.gob.mx/wdelito/"
# 
# ## Selecting periods page: Fuero Federal
# 
# ## This does not contain the information.
# url <- "http://estadisticadelictiva.secretariadoejecutivo.gob.mx/mondrian/testpage.jsp"
# 
# ## Year, state and month
# url <- "http://estadisticadelictiva.secretariadoejecutivo.gob.mx/mondrian/testpage.jsp?query=anio_ent_mes_ff"
# 
# 
# ## All crime types
# url <- "http://estadisticadelictiva.secretariadoejecutivo.gob.mx/mondrian/"
# 
# ## Parsing the site
# doc <- htmlParse(url)
# 
# ## Obtaining root
# root <- xmlRoot(doc)
# 
# ## Some numbers to look at
# length(xmlChildren(root)) ## Two elements in the structure
# names(xmlChildren(root)) ## Names of the two elements
# length(xmlChildren(xmlChildren(root)[[2]]))
# 
# ## Selecting body children
# body <- xmlChildren(xmlChildren(root)[[2]])
# 
# names(body)
# 
# body
# 
# download.file("http://www.secretariadoejecutivo.gob.mx/work/models/SecretariadoEjecutivo/Resource/131/1/images/publicacionFebrero2014_032014.pdf", "mes.pdf")
# 
# getNodeSet(root, "//*")
```


